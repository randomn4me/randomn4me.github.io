<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://audacis.net name=base><title>~/pkuehn ‚Ä¢ Home Manager Garbage Collection gone wrong</title><link href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 105 55"><text y=".7em" font-size="82">üßë‚Äçüíª</text></svg>' rel=icon><link title="~/pkuehn - Atom Feed" href=https://audacis.net/atom.xml rel=alternate type=application/atom+xml><link href="https://audacis.net/inter_subset_en.css?h=d8cf4ad058d6c3a4015b" rel=stylesheet><link href="https://audacis.net/main.css?h=1c70d4de531fe23530c5" rel=stylesheet><link href="https://audacis.net/skins/lavender.css?h=31ee0a710ed660d122f6" rel=stylesheet><meta content="light dark" name=color-scheme><meta content="A simple mistake in my NixOS configuration led to a full disk." name=description><meta content="A simple mistake in my NixOS configuration led to a full disk." property=og:description><meta content="index, nofollow" name=robots><meta content="Home Manager Garbage Collection gone wrong" property=og:title><meta content=article property=og:type><meta content=en_GB property=og:locale><meta content=https://audacis.net/posts/wrong-homemanager-garbage-collection/ property=og:url><meta content=~/pkuehn property=og:site_name><meta content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'" http-equiv=Content-Security-Policy><noscript><link href=https://audacis.net/no_js.css rel=stylesheet></noscript><script src=https://audacis.net/js/initializeTheme.min.js></script><script defer src=https://audacis.net/js/themeSwitcher.min.js></script><script src="https://audacis.net/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://audacis.net>~/pkuehn</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://audacis.net/posts/> /posts </a><li><a class="nav-links no-hover-padding" href=https://audacis.net/now/> /now </a><li><a class="nav-links no-hover-padding" href=https://audacis.net/about/> /about </a></li><div class=nav-navs id=menu-icons-group><li class=js><div aria-label="Click or press $SHORTCUT to open search" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" id=search-button role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><li class="theme-switcher-wrapper js"><div aria-label="Toggle dark mode" title="Toggle dark/light mode" aria-pressed=false class=theme-switcher role=button tabindex=0></div><div aria-label="Reset mode to default" class="theme-resetter arrow" title="Reset mode to default" aria-hidden=true role=button tabindex=0></div></div></ul></div></nav></header><div class=content><main><article><h1 class=article-title>Home Manager Garbage Collection gone wrong</h1><ul class=meta><li>16th Sep 2024<li title="394 words"><span aria-hidden=true class=separator>‚Ä¢</span>2 min read<li class=tag><span aria-hidden=true class=separator>‚Ä¢</span>Tags:¬†<li class=tag><a href=https://audacis.net/tags/sysadmin/>sysadmin</a>,¬†<li class=tag><a href=https://audacis.net/tags/nixos/>nixos</a>,¬†<li class=tag><a href=https://audacis.net/tags/home-manager/>home-manager</a></ul><section class=body><p>I recently ran into a problem with my NixOS server. As a proud and convinced NixOS user, I use all the fancy features, like <a href=https://nix-community.github.io/home-manager/>Home Manager</a> to manage my user configuration. Unfortunately, I made a mistake in my configuration, which led to a full disk and the inability to update my system any longer.<h2 id=the-problem>The Problem</h2><p>The NixOS garbage collection is configured to run every day and to just keep the last 14 days of generations. It worked well, but still the storage was still filling up. I suspected some services like Mastodon, which I ran at that time, to be the culprit with all the media files and the database.<p>However, after a short investigation, I found out that the root cause was actually the <code>/nix/store</code> directory. As I use flakes to manage my NixOS configuration, I checked on my laptop as well, and noticed a similar problem with nearly 300 GB of <code>/nix/store</code> usage and 295 GB in <code>/nix/store/.links</code> ü§Ø While this might not be uncommon when installing a lot of packages with a lot of different versions, it still seemed a bit too much for me, as I try to keep my systems as clean as possible.<p>I checked in with my local <a href=https://www.chaos-darmstadt.de/2023/erstes-nixos-meetup/>NixOS community</a> (esp. <a href=https://darmstadt.social/@atemu>Atemu</a>) and they pointed me to the Home Manager garbage collection as this needs to be configured separately from the NixOS garbage collection. After a <code>nix-env --list-generations</code> it confirmed, that I had just 7 NixOS generations on my system. But a short<pre class=z-code><code><span class="z-text z-plain">nix-store --gc --print-roots | grep -vE "^(/nix/var|/run/\w+-system|\{memory|\{censored|/proc/maps/)"
</span></code></pre><p>showed a shitload of generations, which I did not expected.<h2 id=the-solution>The Solution</h2><p>After some hints, I found out that I had not configured the Home Manager garbage collection. I setup a quick home-manager module, which mirrors my NixOS settings, so that it runs in sync with the NixOS garbage collection and defaults to <code>true</code>!<pre class="language-nix z-code" data-lang=nix><code class=language-nix data-lang=nix><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">  <span class="z-variable z-parameter z-function z-1 z-nix">lib</span><span class="z-keyword z-operator z-nix">,</span>
</span><span class="z-source z-nix">  <span class="z-variable z-parameter z-function z-1 z-nix">config</span><span class="z-keyword z-operator z-nix">,</span>
</span><span class="z-source z-nix">  <span class="z-variable z-parameter z-function z-1 z-nix">osConfig</span><span class="z-keyword z-operator z-nix">,</span>
</span><span class="z-source z-nix">  <span class="z-keyword z-operator z-nix">...
</span></span><span class="z-source z-nix"><span class="z-keyword z-operator z-nix"></span><span class="z-punctuation z-definition z-entity z-function z-nix">}</span><span class="z-punctuation z-definition z-function z-nix">:</span>
</span><span class="z-source z-nix">
</span><span class="z-source z-nix"><span class="z-keyword z-other z-nix">with</span> <span class="z-variable z-parameter z-name z-nix">lib</span>;
</span><span class="z-source z-nix">
</span><span class="z-source z-nix"><span class="z-keyword z-other z-nix">let</span>
</span><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">cfg</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">config</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">custom</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">gc</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix"><span class="z-keyword z-other z-nix">in</span>
</span><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">options</span>.<span class="z-entity z-other z-attribute-name z-multipart z-nix">custom</span>.<span class="z-entity z-other z-attribute-name z-multipart z-nix">gc</span>.<span class="z-entity z-other z-attribute-name z-multipart z-nix">enable</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">mkOption</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">description</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>Enable home-manager-gc based on nixos gc<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">type</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">types</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">bool</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">default</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-constant z-language z-nix">true</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">
</span><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">config</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">mkIf</span> <span class="z-variable z-parameter z-name z-nix">cfg</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">enable</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">nix</span>.<span class="z-entity z-other z-attribute-name z-multipart z-nix">gc</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">automatic</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">osConfig</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">nix</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">gc</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">automatic</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">options</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">osConfig</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">nix</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">gc</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">options</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">    <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></code></pre><p>After applying this configuration and <code>nix-collect-garbage --delete-older-than 14d</code>, I was rewarded with the following output:<pre class=z-code><code><span class="z-text z-plain">deleting unused links...
</span><span class="z-text z-plain">note: currently hard linking saves 29539.49 MiB
</span><span class="z-text z-plain">476109 store paths deleted, 201139.22 MiB freed
</span></code></pre><p>I also ran that on my server, and it cleared up some critical space as well.<p>With the new Home Manager module in place, and in the fashion of NixOS, I will never run into this problem again ü•≥ Thanks again to the NixOS community for the help and support!</section></article></main><span class=hidden id=copy-success> Copied! </span><span class=hidden id=copy-init> Copy code to clipboard </span><script defer src=https://audacis.net/js/copyCodeToClipboard.min.js></script></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" href=https://audacis.net/atom.xml> <img alt=feed loading=lazy src=https://audacis.net/social_icons/rss.svg title=feed> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://github.com/randomn4me> <img alt=github loading=lazy src=https://audacis.net/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://orcid.org/0000-0002-1739-876X> <img alt=orcid loading=lazy src=https://audacis.net/social_icons/orcid.svg title=orcid> </a><li><a class="nav-links no-hover-padding social" href="https://scholar.google.com/citations?user=yEOvWXAAAAAJ&hl=en" rel=" me"> <img alt=scholar loading=lazy src=https://audacis.net/social_icons/google-scholar.svg title=scholar> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://www.linkedin.com/in/ph-kuehn/> <img alt=linkedin loading=lazy src=https://audacis.net/social_icons/linkedin.svg title=linkedin> </a></ul></nav><nav class=nav-navs></nav><div class=credits><small> <p><p>Philipp K√ºhn</p> Powered by <a href=https://www.getzola.org>Zola</a> & <a href=https://github.com/welpo/tabi>tabi</a> </small></div></section><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><h1 class=visually-hidden id=modalTitle>Search</h1><div id=modal-content><div id=searchBar><div aria-hidden=true class=search-icon><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search‚Ä¶ role=combobox spellcheck=false><div class="close-icon interactive-icon" title="Clear search" id=clear-search role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></div></div><div id=results-container><div id=results-info><span id=zero_results> No results</span><span id=one_results> $NUMBER result</span><span id=many_results> $NUMBER results</span><span id=two_results> $NUMBER results</span><span id=few_results> $NUMBER results</span></div><div id=results role=listbox></div></div></div></div></footer>